#! /bin/sh

rm -f ~/.pgpass
echo "*:*:*:${DIRECTOR_DB_USER}:${DIRECTOR_DB_PASS}" >~/.pgpass
chmod 0600 ~/.pgpass

PG_ARGS="--host=${POSTGRES_HOST} --port=${POSTGRES_PORT}"
PG_DIR_ARGS="${PG_ARGS} -U ${DIRECTOR_DB_USER} -d ${DIRECTOR_DB}"

psql ${PG_ARGS} -U ${DIRECTOR_DB_USER} -lqt | cut -d \| -f 1 | grep -qw ${DIRECTOR_DB}
if [ $? -ne 0 ]; then
  echo "Icinga director database ${DIRECTOR_DB} does not exist."
  exit 1
fi

if [ ! -e "/etc/icingaweb2/enabledModules/incubator" ]; then
  icingacli module enable incubator
fi

if [ ! -e "/etc/icingaweb2/enabledModules/director" ]; then
  icingacli module enable director
fi

cat /etc/icingaweb2/resources.ini | grep -qw director 2>&1 >/dev/null
if [ $? -ne 0 ]; then
  cat >>/config/icingaweb2/resources.ini <<EOF
[director]
type = "db"
db = "pgsql"
host = "${POSTGRES_HOST}"
port = "${POSTGRES_PORT}"
dbname = "${DIRECTOR_DB}"
username = "${DIRECTOR_DB_USER}"
password = "${DIRECTOR_DB_PASS}"
use_ssl = "0"
charset = "utf8"
EOF

  mkdir -p /config/icingaweb2/modules/director
  cat >/config/icingaweb2/modules/director/config.ini <<EOF
[db]
resource = "director"
EOF

  chown -R root:icingaweb2 /config/icingaweb2
  chmod -R g+rw /config/icingaweb2
fi

icingacli director migration run --verbose
